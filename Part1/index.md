<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

* [Part1](#part1)
	* [demo1项目介绍](#demo1项目介绍)
	* [服务器&客户端](#服务器客户端)
		* [安装nodejs](#安装nodejs)
		* [启动服务器程序](#启动服务器程序)
		* [验证TCP服务器](#验证tcp服务器)
	* [通信](#通信)
		* [ESP8266 验证AT指令](#esp8266-验证at指令)
	* [服务器与通信之间的联调](#服务器与通信之间的联调)
		* [联调](#联调)
	* [硬件](#硬件)
		* [STM32串口调试](#stm32串口调试)
	* [硬件与通信之间的联调](#硬件与通信之间的联调)
	* [整个demo1联调效果](#整个demo1联调效果)
	* [Part1 作业](#part1-作业)
	* [Part1 总结](#part1-总结)
	* [声明](#声明)
	* [下一个demo项目](#下一个demo项目)

<!-- /code_chunk_output -->
# Part1
最后修改时间：2018/5/22
鉴于物联网项目战线很长，一般是硬件与软件是由不同的人负责，毕竟两者兼学就意味着两者都不可能投入太多时间。这个教程的作用在于，我直接给个成品，给你指明方向，然后自己学习，减少那些“花费精力与时间学习了部分知识发现竟然没什么用”的成本。Part1只是简单地把整个demo1运行起来，先知道我们要做的最终效果，再去模仿学习。
## demo1项目介绍
@import "./images/项目图.png"
经过我的学习与实践，我这个物联网项目包括四个部分，如图从左往右包含了硬件部分、通信部分、服务器部分、客户端部分。
- 硬件：STM32。
- 通信：ESP8266 通过WIFI连接到TCP服务器。
- 服务器：包含HTTP服务器与TCP服务器。
- 客户端：用浏览器打开Web页面，本质就是连接到HTTP服务器。
- 硬件与通信之间：就是通过UART串口通信，STM32用AT指令控制ESP8266。
- 通信与服务器之间：STM32能过AT指令控制ESP8266，连接WIFI并与服务器建立TCP连接。
- 服务器与客户端之间：浏览器打开网页（即建立HTTP连接）。  

各部分其实并不是固定死的，如硬件部分STM32可以换成树莓派、arduino等。通信部分可以换成以太网、NB-IOT（这个必须要对接运营商的平台）。服务器部分系统要用window还是linux，语言要用php还是nodejs还是其它的。客户端就是PC、手机等。当然我不可能所有都讲，我就选择一些来讲，大家学习之后明白了思路，就可以根据实际要求自己定义实现方案。为了大家能更好地“傻瓜式”运行起来，环境方面，大家都使用 __nodejs（8.0以上），编辑器vscode，浏览器Chrome__ 。
## 服务器&客户端
服务器&客户端调试，基本证明软件部分能正常运行。服务器左侧数据全部由网络调试助手模拟。后面各部分也是同理，先用调试工具等效替代进行模拟调试。
@import "./images/服务器调试总结.png"
### 安装nodejs 
1. 搜索nodejs官网
2. 下载nodejs，大家下载稳定版本。（LTS: Long Term Support ）
@import "./images/下载nodejs.png"
3. 在cmd里运行`node -v`与`npm -v`验证nodejs安装成功
@import "./images/验证nodejs安装成功.png"
这个验证很常见，有两个用途：1.程序安装成功。2.环境变量（PATH） 设置正确。
### 启动服务器程序
注意使用 __chrome浏览器__，暂时已经发现360浏览器内核太旧无法支持新版的JQuery而报错。[FAQ #1001](../FAQ.html)
1. 点击`Part1/demo/运行.bat`
@import "./images/运行demo.gif"
脚本运行起来会自动打开浏览器对应的页面`http://${HOST}:{HTTP_PORT}/tcp-page`（我的环境就是http://127.0.0.1:8888/tcp-page，${variable}这种样式代表的是变量，大家需要根据自己的情况修改这个变量的值），顺手就把HTTP服务器验证完毕。
2. 手机连接同一个WIFI，使用浏览器访问相同的网址。
@import "./images/demo1手机效果图.png"
注意符号要用英文符号，中文符号是不行的。（两者区别就是，中文符号占两个空格位置，可自行搜索全角与半角的区别）


### 验证TCP服务器
要验证TCP服务器，你需要 __网络调试助手__。[网盘分享](https://pan.baidu.com/s/1YGQKlV0F9FadfUhYLSFEJA)（点击右键 在新标签页中打开链接）
1. 运行网络调试助手，风络设置：协议类型TCP Client、本地主机地址：127.0.0.1,填写端口:2424。点击连接。
@import "./images/网络调试助手配置.png"
连接成功会返回OK，并且网页上会有显示建立连接。
2. 联调效果，网页上点击按钮，能发送字符串到网络调试助手，而网络调试助手发送的字符串，能在网页上显示出来，如果发送的是`LED1:1`，还能改变网页LED状态。
@import "./images/TCP服务器联调.gif"
至此，服务器已经通过调试软件来验证是成功的：
@import "./images/服务器调试总结.png"
## 通信
接下来要做的就是，将网络调试助手替换成ESP8266。或许有人会问，为什么不直接用ESP8266直接调试，中间还搞个网络调试助手来模拟ESP8266浪费大家的青春年华？那是因为物联网项目的战线实在太长，光是软件部分就要搞这么久，引入硬件（近乎玄学）就需要更久了，直接整个demo1联调，只要出一个问题都不想继续搞下去了。 __所以必须保证每一环节能自我证明能够正常运行，才能安心地与其它环节对接联调，对接联调出现问题时能够回到自证调试，从而快速确定问题位置。__

在项目中，ESP8266作为通信部分，左边与STM32相连通过串口通信进行数据交互，右边通过WIFI连接TCP服务器进行数据交互。所以自证的时候，左侧在电脑上用串口调试助手模拟STM32，右侧用网络调试助手模拟TCP服务器。
@import "./images/ESP8266调试总结.png"
### ESP8266 验证AT指令
1. ESP8266接线  
ESP8266都不知道火了多久了，文档还是一样的散乱，对新手还是那么的不友好，至少是不知道入口在哪里，怎么进行最简单的验证~
首先我们在代理商安信可的[文档中心](http://wiki.ai-thinker.com/esp8266/docs)里找到用户手册。里面可以找到esp8266-01的接线图，使用USB转TTL模块连接到电脑里。
@import "./images/安信可 文档中心 用户手册.png"
@import "./images/ESP8266-01接线图.png"
因为有多个地方要接3.3V，大家可以用开发板与usb转串口配合着接线，反正我是用面包板加电源模块接的。
2. 串口调试助手 验证AT指令 [网盘分享](https://pan.baidu.com/s/1pE4hrT1RTdhZVFbow4SSOg)  
第一个文档有AT指令的介绍，根据第二个文档做一下AT指令的最简单的验证，比如连接WIFI、连接TCP等都有讲，我就不多加搬运了~
@import "./images/ESP8266 AT指令文档.png"
3. 一样是使用网络调试助手，不同的是这次使用网络调试助手充当TCP服务器端。通过AT指令成功连接WIFI，连接TCP服务器，就验证ESP8266能正常运行了。
@import "./images/esp8266连接网络调试助手.png"
若验证AT指令失败，请尝试重新烧录AT固件 [ESP8266 烧录固件](./esp8266烧录固件.html)
后面就是将TCP服务器换成我们之前运行的服务器。

## 服务器与通信之间的联调
完成以上步骤，服务器与ESP8266分别都自证成功，现在将两者联调起来。相对于服务器自证来说，就是将TCP客户端从网络调试助手替换为ESP8266，相对于通信自证来说，就是将TCP服务器从网络调试助手替换为我们编写的服务器。联调的效果就变成了：
@import "./images/通信与服务器联调.png"
### 联调
1. 点击 运行.bat，运行服务器。
2. 通过串口调试助手向ESP8266发送AT指令。
因为我知道我们都很懒，我把指令都复制过来了。
- `AT+CWJAP="${WIFI_SSID}","${PASSWORD}"` 填入自己的WIFI账号密码并发送，让ESP8266连接WIFI __（再次提醒${variable}这种样式代表的是变量，大家需要根据自己的情况修改这个变量的值）__
- `AT+CIPSTART="TCP","${HOST}",${PORT}` 填入你的IP地址与端口并发送，建立TCP连接，像我就是`AT+CIPSTART="TCP","127.0.0.1",2424` ，大家肯定跟我不一样的，要自己换。
- `AT+CIPSEND=6` 向TCP发送六个字节，然后就可以发LED1:0，这样的数据。
- `AT+CIPCLOSE` 关闭TCP连接
@import "./images/通信与服务器联调效果.gif"
我手上测试的AT固件是1.6版本的，`AT+GMR`查看版本。
如果失败，请回到之前步骤重新验证这两个环节，以确认是服务器问题，还是ESP8266问题。

## 硬件
现在就是要自证硬件环节没问题，使用串口调试助手模拟ESP8266，手动模拟出TCP服务器的数据交互。特别注意，对于STM32我们将会使用两个串口，串口0用于调试。串口1用于与ESP8266连接（用串口调试助手代替模拟）。
@import "./images/硬件调试.png"
对于STM32来说，它要做的就是三件事：
1. 串口0打印debug信息(用于连接电脑调试)，串口1与ESP8266连接（用串口调试助手代替模拟）。
2. 使用AT指令操作ESP8266，保证与服务器建立起TCP连接，并且在掉失连接时重新连接。
3. 采集传感器数据（可以用悬空的ADC来生成随机数据，同时连接到地或电源，就能得到0或3.3的数据）并发送到串口1里，从串口1中接收数据，根据数据开关LED0、LED1。

### STM32串口调试
所需引脚：串口1、串口2、ADC1、LED1、LED2。
串口1：连接电脑，打印调试数据
串口2：连接ESP8266，进行通信
ADC1：不断采集电量并发送给服务器，当大于3V时发送LED1=1点亮LED1，当小于1V时发送LED1=0并关闭LED1。

stm32工程代码在`Part1/demo1-stm32`目录下，手上没有比较好的硬件，只能用机智云免费送的小板子来简单示范一下，是中容量，大家需要根据自己的板子修改容量，并根据WIFI名密码来修改成自己的。如果哪位网友愿意写一份原子开发板与野火开发板的stm32代码，请分享给我，我分享给大家用。
stm32串口调试相信大家没难度~


## 硬件与通信之间的联调
相对于硬件自证来说，无非就是将串口1把串口调试助手更换为ESP8266。
整个效果回到了demo1项目图：
@import "./images/项目图.png"
整个过程包含以下过程：
```puml
STM32 -> ESP8266 : AT指令连接TCP服务器
ESP8266 -> TCP与HTTP服务器 : 通过WIFI将数据转发到服务器
TCP与HTTP服务器 --> ESP8266 : 连接成功，返回'OK'
ESP8266 --> STM32 : 转发'OK'
STM32 -> ESP8266 : 发送实时数据
ESP8266 -> TCP与HTTP服务器 : 转发实时数据
手机或电脑 -> TCP与HTTP服务器: 打开网页
TCP与HTTP服务器 --> 手机或电脑: 网页显示实时数据
手机或电脑 -> TCP与HTTP服务器: 点击开LED1按钮
TCP与HTTP服务器 -> ESP8266: 发送'LED1:1'
ESP8266 -> STM32 : 转发'LED1:1'
STM32 --> LED1 : 打开LED1
```
## 整个demo1联调效果

@import "./images/demo1-stm32效果图.gif"

@import "./images/demo1-stm32-页面与串口效果图.gif"
由于demo1只是简单地示范一下，没有花太多时间去完善做好健壮性，所以在乱操作时可能会触发错误把程序跑崩。
## Part1 作业
先给大家展示一下武器排行榜：
@import "../images/武器排行榜1.png"
@import "../images/武器排行榜2.png"
@import "../images/武器排行榜3.png"
- 学习软件开发者的神器：git与github [廖雪峰的官方网站-Git教程](https://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000)
不必全部操作都学会，只要学会基本操作满足自己的需求就行了，后面发现新需求再继续深入学习。

## Part1 总结
由于物联网项目战线很长，一旦出了问题排查很费时间的，所以在设计与开发时都要最大程度上方便排查。
__物联网项目出现异常时，确保能让调试人员在3分钟内正确定位到问题所在环节。__
__每一环节必须拥有快速自证的能力。__
## 声明
保留一切权利，禁止商业转载，非商业转载时必须保留此声明与网址：https://github.com/alwxkxk/soft-and-hard
## 下一个demo项目
demo1只是用来引大家入门的，真正能拿得出手的是下一个demo项目。但在做下一个demo项目之前，我们先学习完demo1里涉及到的知识，开始[Part2阅读](../Part2/index.html)。学习完之后，我们讨论一下demo1的不足，然后引出demo2。
demo2大约在Part4出现，会一步步地引入数据库，添加数据可视化，优化数据传输实时性（web方面引入websocket，硬件通信引入MQTT协议，所以ESP8266会使用自己编写的固件取代AT固件），并且做出PC端软件（就是.exe文件，点击就可运行的那种，不需要浏览器，不需要客户自己安装nodejs，还能定制出自己的图标，使用.exe方显是大企业产品）。

